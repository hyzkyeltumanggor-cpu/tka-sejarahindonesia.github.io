<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <title>CBT Sejarah Indonesia</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body {
            margin: 0;
            font-family: Arial;
            background: #f1f5f9
        }

        header {
            background: #fff;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 2px 8px rgba(0, 0, 0, .08)
        }

        main {
            max-width: 900px;
            margin: 20px auto
        }

        .card {
            background: #fff;
            padding: 16px;
            border-radius: 14px;
            margin-bottom: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, .05)
        }

        button {
            padding: 8px 14px;
            border: 0;
            border-radius: 10px;
            cursor: pointer
        }

        .primary {
            background: #2563eb;
            color: #fff
        }

        .ghost {
            background: #e0e7ff;
            color: #1e40af
        }

        .choice {
            border: 1px solid #c7d2fe;
            padding: 10px;
            border-radius: 10px;
            margin: 6px 0;
            cursor: pointer
        }

        .choice.active {
            background: #eef2ff
        }

        .hidden {
            display: none
        }

        .progress {
            height: 10px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden
        }

        .progress i {
            display: block;
            height: 100%;
            background: #2563eb;
            width: 0
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        td,
        th {
            border: 1px solid #e5e7eb;
            padding: 6px
        }

        #timer {
            font-weight: bold
        }
    </style>
</head>

<body>

    <header>
        <b>CBT Sejarah Indonesia</b>
        <div>
            <span id="timer"></span>
            <button class="ghost" onclick="loginGuru()">Mode Guru</button>
        </div>
    </header>

    <!-- LOGIN SISWA -->
    <section id="login">
        <div class="card" style="max-width:360px;margin:40px auto">
            <h3>Login Siswa</h3>
            <input id="nama" placeholder="Nama Lengkap" style="width:100%;padding:8px"><br><br>
            <input id="kelas" placeholder="Kelas" style="width:100%;padding:8px"><br><br>
            <button class="primary" style="width:100%" onclick="loginSiswa()">Masuk</button>
        </div>
    </section>

    <!-- QUIZ -->
    <main id="quiz" class="hidden">
        <div class="card">
            <div class="progress"><i id="bar"></i></div>
            <p id="info"></p>
            <h3 id="q"></h3>
            <div id="opsi"></div>
            <div style="margin-top:10px">
                <button class="ghost" onclick="prev()">Sebelumnya</button>
                <button class="ghost" onclick="next()">Berikutnya</button>
                <button class="primary" onclick="finish()">Selesai</button>
            </div>
        </div>
    </main>

    <!-- HASIL -->
    <section id="hasil" class="hidden">
        <div class="card" style="max-width:360px;margin:40px auto;text-align:center">
            <h2>Hasil Ujian</h2>
            <h1 id="nilai"></h1>
            <p id="status"></p>
            <p style="font-size:13px;color:#555">Jawaban terkunci</p>
        </div>
    </section>

    <script>
        /* =====================================================
           STORAGE KEY
        ===================================================== */
        const EXAM_KEY = "exam_config";
        const SCORE_KEY = "exam_scores";
        const LOG_KEY = "exam_logs";

        /* =====================================================
           BANK SOAL (SUDAH DIVALIDASI)
        ===================================================== */
        const RAW_BANK_SOAL = [/* 50 soal valid */
            { q: "Proklamasi Kemerdekaan Indonesia terjadi pada …", c: ["17 Agustus 1945", "18 Agustus 1945", "16 Agustus 1945", "20 Agustus 1945"], a: 0 },
            { q: "Tokoh pembaca teks Proklamasi adalah …", c: ["Soekarno", "Moh. Hatta", "Ahmad Soebardjo", "Sutan Sjahrir"], a: 0 },
            { q: "Teks Proklamasi diketik oleh …", c: ["Sayuti Melik", "Soekarno", "Fatmawati", "Ahmad Soebardjo"], a: 0 },
            { q: "Pancasila disahkan pada …", c: ["18 Agustus 1945", "17 Agustus 1945", "1 Juni 1945", "22 Juni 1945"], a: 0 },
            { q: "Ketua BPUPKI adalah …", c: ["Radjiman Wedyodiningrat", "Soekarno", "Moh. Hatta", "Ki Hajar Dewantara"], a: 0 },
            { q: "Perang Diponegoro terjadi pada tahun …", c: ["1825–1830", "1830–1835", "1815–1820", "1808–1811"], a: 0 },
            { q: "Pendiri Budi Utomo adalah …", c: ["Dr. Soetomo", "Ki Hajar Dewantara", "Kartini", "Cipto Mangunkusumo"], a: 0 },
            { q: "Budi Utomo berdiri pada tanggal …", c: ["20 Mei 1908", "28 Oktober 1928", "17 Agustus 1945", "1 Juni 1945"], a: 0 },
            { q: "Sumpah Pemuda diikrarkan pada …", c: ["28 Oktober 1928", "20 Mei 1908", "17 Agustus 1945", "1 Juni 1945"], a: 0 },
            { q: "VOC didirikan pada tahun …", c: ["1602", "1596", "1619", "1620"], a: 0 },
            { q: "Sistem Tanam Paksa diberlakukan oleh …", c: ["Van den Bosch", "Daendels", "Raffles", "Diponegoro"], a: 0 },
            { q: "Kerajaan Hindu tertua di Indonesia adalah …", c: ["Kutai", "Tarumanegara", "Majapahit", "Sriwijaya"], a: 0 },
            { q: "Sriwijaya bercorak agama …", c: ["Buddha", "Hindu", "Islam", "Kristen"], a: 0 },
            { q: "Raja terbesar Majapahit adalah …", c: ["Hayam Wuruk", "Ken Arok", "Airlangga", "Kertanegara"], a: 0 },
            { q: "Patih Majapahit terkenal adalah …", c: ["Gajah Mada", "Ken Arok", "Mulawarman", "Balaputradewa"], a: 0 },
            { q: "Sumpah Palapa diucapkan oleh …", c: ["Gajah Mada", "Hayam Wuruk", "Ken Arok", "Airlangga"], a: 0 },
            { q: "Kerajaan Islam pertama di Indonesia adalah …", c: ["Samudera Pasai", "Demak", "Aceh", "Banten"], a: 0 },
            { q: "Pendiri Kerajaan Demak adalah …", c: ["Raden Patah", "Sultan Agung", "Hasanuddin", "Iskandar Muda"], a: 0 },
            { q: "Jepang mulai menduduki Indonesia pada tahun …", c: ["1942", "1941", "1943", "1940"], a: 0 },
            { q: "Romusha berarti …", c: ["Kerja paksa", "Kerja sukarela", "Tentara", "Petani"], a: 0 },
            { q: "Presiden pertama RI adalah …", c: ["Soekarno", "Moh. Hatta", "Sutan Sjahrir", "Soedirman"], a: 0 },
            { q: "Wakil Presiden pertama RI adalah …", c: ["Moh. Hatta", "Soekarno", "Sjahrir", "Soedirman"], a: 0 },
            { q: "Konferensi Asia Afrika berlangsung tahun …", c: ["1955", "1950", "1960", "1949"], a: 0 },
            { q: "Ibu kota RI pertama adalah …", c: ["Yogyakarta", "Jakarta", "Bandung", "Surabaya"], a: 0 },
            { q: "Pendiri Sarekat Islam adalah …", c: ["Haji Samanhudi", "Cokroaminoto", "Soekarno", "Kartini"], a: 0 },
            { q: "Pendiri PNI adalah …", c: ["Soekarno", "Moh. Hatta", "Sjahrir", "Soedirman"], a: 0 },
            { q: "Pengakuan kedaulatan RI tahun …", c: ["1949", "1948", "1950", "1947"], a: 0 },
            { q: "Agresi Militer Belanda II terjadi tahun …", c: ["1948", "1947", "1949", "1950"], a: 0 },
            { q: "Kerajaan Tarumanegara terletak di …", c: ["Jawa Barat", "Sumatra", "Kalimantan", "Jawa Tengah"], a: 0 },
            { q: "Raja Kutai terkenal adalah …", c: ["Mulawarman", "Purnawarman", "Airlangga", "Ken Arok"], a: 0 },
            { q: "Majapahit bercorak agama …", c: ["Hindu-Buddha", "Islam", "Kristen", "Animisme"], a: 0 },
            { q: "Tujuan Sumpah Pemuda adalah …", c: ["Persatuan bangsa", "Kemerdekaan", "Ekonomi", "Pendidikan"], a: 0 },
            { q: "Wali Songo menyebarkan agama …", c: ["Islam", "Hindu", "Buddha", "Kristen"], a: 0 },
            { q: "Perang Aceh dipimpin oleh …", c: ["Teuku Umar", "Pattimura", "Diponegoro", "Imam Bonjol"], a: 0 },
            { q: "Nama asli Pattimura adalah …", c: ["Thomas Matulessy", "Hasanuddin", "Teuku Umar", "Imam Bonjol"], a: 0 },
            { q: "Kerajaan Samudera Pasai terletak di …", c: ["Aceh", "Jawa Timur", "Maluku", "Kalimantan"], a: 0 },
            { q: "Sultan Aceh terkenal adalah …", c: ["Iskandar Muda", "Sultan Agung", "Hasanuddin", "Raden Patah"], a: 0 },
            { q: "Perjanjian Linggarjati tahun …", c: ["1946", "1947", "1948", "1949"], a: 0 },
            { q: "Perjanjian Renville tahun …", c: ["1948", "1947", "1949", "1950"], a: 0 },
            { q: "Agresi Militer Belanda I tahun …", c: ["1947", "1946", "1948", "1949"], a: 0 }
        ];

        /* =====================================================
           UTIL BANK
        ===================================================== */
        function shuffleDaily(arr) {
            const seed = Number(new Date().toISOString().slice(0, 10).replace(/-/g, ""));
            let a = [...arr], s = seed;
            for (let i = a.length - 1; i > 0; i--) {
                s = (s * 9301 + 49297) % 233280;
                const j = Math.floor((s / 233280) * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }
        const BANK = shuffleDaily(RAW_BANK_SOAL).slice(0, 50);

        /* =====================================================
           ENGINE UJIAN
        ===================================================== */
        let i = 0, jawaban = new Array(BANK.length).fill(null), timer;

        function render() {
            info.innerText = `Soal ${i + 1}/${BANK.length}`;
            q.innerText = BANK[i].q;
            opsi.innerHTML = "";
            BANK[i].c.forEach((t, x) => {
                const d = document.createElement("div");
                d.className = "choice" + (jawaban[i] === x ? " active" : "");
                d.innerText = String.fromCharCode(65 + x) + ". " + t;
                d.onclick = () => { jawaban[i] = x; render() };
                opsi.appendChild(d);
            });
            bar.style.width = (jawaban.filter(x => x !== null).length / BANK.length * 100) + "%";
        }
        function prev() { if (i > 0) { i--; render() } }
        function next() { if (i < BANK.length - 1) { i++; render() } }

        function startTimer(m) {
            const end = Date.now() + m * 60000;
            timer = setInterval(() => {
                const sisa = end - Date.now();
                if (sisa <= 0) { finish() }
                const mm = Math.floor(sisa / 60000);
                const ss = Math.floor((sisa % 60000) / 1000);
                timerEl.innerText = `Sisa waktu ${mm}:${String(ss).padStart(2, "0")}`;
            }, 1000);
        }

        function finish() {
            clearInterval(timer);
            let benar = 0;
            BANK.forEach((s, x) => { if (jawaban[x] === s.a) benar++ });
            const siswa = JSON.parse(localStorage.getItem("siswa"));
            const scores = JSON.parse(localStorage.getItem(SCORE_KEY) || "[]");
            scores.push({ nama: siswa.nama, kelas: siswa.kelas, nilai: benar, total: BANK.length, waktu: new Date().toLocaleString() });
            localStorage.setItem(SCORE_KEY, JSON.stringify(scores));
            quiz.classList.add("hidden");
            hasil.classList.remove("hidden");
            nilai.innerText = benar;
            status.innerText = benar >= 35 ? "LULUS" : "TIDAK LULUS";
        }

        /* =====================================================
           LOGIN SISWA
        ===================================================== */
        function loginSiswa() {
            const cfg = JSON.parse(localStorage.getItem(EXAM_KEY) || "null");
            if (!cfg || !cfg.open) { alert("Ujian belum dibuka"); return; }
            const token = prompt("Masukkan token ujian:");
            if (token !== cfg.token) { alert("Token salah"); return; }
            if (!nama.value || !kelas.value) { alert("Lengkapi data"); return; }
            localStorage.setItem("siswa", JSON.stringify({ nama: nama.value, kelas: kelas.value }));
            login.classList.add("hidden");
            quiz.classList.remove("hidden");
            startTimer(cfg.duration);
            render();
        }

        /* =====================================================
           LOG PELANGGARAN
        ===================================================== */
        function logPelanggaran(p) {
            const s = JSON.parse(localStorage.getItem("siswa") || "{}");
            const logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
            logs.push({ nama: s.nama || "-", kelas: s.kelas || "-", waktu: new Date().toLocaleString(), pelanggaran: p });
            localStorage.setItem(LOG_KEY, JSON.stringify(logs));
        }
        document.addEventListener("visibilitychange", () => { if (document.hidden) logPelanggaran("Pindah tab") });
        window.addEventListener("blur", () => logPelanggaran("Window blur"));
        window.addEventListener("beforeunload", () => logPelanggaran("Refresh / keluar"));

        /* =====================================================
           MODE GURU
        ===================================================== */
        function loginGuru() {
            if (prompt("Password Guru") !== "guru123") { alert("Salah"); return; }
            const scores = JSON.parse(localStorage.getItem(SCORE_KEY) || "[]");
            const logs = JSON.parse(localStorage.getItem(LOG_KEY) || "[]");
            document.body.innerHTML = `
  <main style="padding:20px">
    <h2>MODE GURU</h2>
    Token <input id="gtoken"><br><br>
    Durasi (menit) <input id="gdur" type="number" value="90"><br><br>
    <button onclick="openExam()">Buka Ujian</button>
    <button onclick="lockExam()">Kunci Ujian</button>
    <button onclick="exportNilai()">Export Nilai</button>
    <h3>Nilai</h3>${table(scores)}
    <h3>Log Pelanggaran</h3>${table(logs)}
  </main>`;
        }
        function openExam() {
            localStorage.setItem(EXAM_KEY, JSON.stringify({ open: true, token: gtoken.value, duration: Number(gdur.value) }));
            alert("Ujian dibuka");
        }
        function lockExam() {
            const c = JSON.parse(localStorage.getItem(EXAM_KEY));
            if (c) { c.open = false; localStorage.setItem(EXAM_KEY, JSON.stringify(c)); alert("Ujian dikunci"); }
        }
        function table(arr) {
            if (!arr.length) return "<p>Kosong</p>";
            const cols = Object.keys(arr[0]);
            return `<table><tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr>` +
                arr.map(r => `<tr>${cols.map(c => `<td>${r[c]}</td>`).join("")}</tr>`).join("") +
                `</table>`;
        }
        function exportNilai() {
            const rows = JSON.parse(localStorage.getItem(SCORE_KEY) || "[]");
            if (!rows.length) { alert("Belum ada nilai"); return; }
            const cols = Object.keys(rows[0]);
            const csv = [cols.join(",")].concat(rows.map(r => cols.map(c => `"${r[c]}"`).join(","))).join("\n");
            const blob = new Blob([csv], { type: "text/csv" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "nilai_ujian.csv";
            a.click();
        }
    </script>

</body>

</html>
